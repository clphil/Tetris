<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TETRIS</title>

  <!-- ── PWA ── -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#080820">
  <!-- iOS : plein écran sans chrome Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="TETRIS">
  <link rel="apple-touch-icon" href="icon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: #080820;
      font-family: 'Arial Black', Arial, sans-serif;
      color: #fff;
      touch-action: none;
    }

    /* ══════════════════════════════════════
       START SCREEN
    ══════════════════════════════════════ */
    #start-screen {
      position: fixed;
      inset: 0;
      background: #080820;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(20px, 5vh, 40px);
      z-index: 500;
    }
    #start-screen.hidden { display: none; }

    #start-title {
      font-size: clamp(3.5rem, 20vw, 8rem);
      font-weight: 900;
      letter-spacing: clamp(6px, 4vw, 16px);
      text-transform: uppercase;
      background: linear-gradient(90deg,
        #ff0000 0%, #ff6600 16%, #ffff00 32%,
        #00ff00 48%, #00aaff 64%, #aa00ff 80%, #ff00aa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titlePulse 2.5s ease-in-out infinite;
    }
    @keyframes titlePulse {
      0%, 100% { filter: brightness(1); }
      50%       { filter: brightness(1.35) drop-shadow(0 0 18px rgba(0,200,255,0.55)); }
    }

    #start-by {
      font-size: clamp(0.7rem, 3.5vw, 1.1rem);
      color: rgba(160, 160, 220, 0.65);
      letter-spacing: clamp(2px, 1.5vw, 5px);
      font-style: italic;
      font-family: Arial, sans-serif;
      font-weight: 400;
    }

    #start-btn {
      margin-top: clamp(8px, 2vh, 20px);
      background: #0a0a30;
      border: 3px solid #00c8ff;
      color: #00c8ff;
      font-family: 'Arial Black', Arial, sans-serif;
      font-size: clamp(1.1rem, 6vw, 1.8rem);
      font-weight: 900;
      letter-spacing: clamp(4px, 2vw, 8px);
      padding: clamp(12px, 3vh, 22px) clamp(36px, 12vw, 72px);
      border-radius: 14px;
      cursor: pointer;
      animation: btnPulse 1.8s ease-in-out infinite;
      -webkit-tap-highlight-color: transparent;
    }
    #start-btn:active { background: #003355; }
    @keyframes btnPulse {
      0%, 100% { box-shadow: 0 0 10px #00c8ff44; }
      50%       { box-shadow: 0 0 30px #00c8ffbb, 0 0 60px #00c8ff33; }
    }

    /* ══════════════════════════════════════
       LAYOUT PAYSAGE (défaut)
       left-panel | center-panel | right-panel
    ══════════════════════════════════════ */
    #app {
      display: flex;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
    }

    /* ── Panneau gauche ── */
    #left-panel {
      flex: 0 0 27%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 6px 4px 18px;
      overflow: hidden;
      min-width: 0;
    }

    /* ── Canvas central ── */
    #center-panel {
      flex: 1 1 0;           /* prend tout l'espace restant */
      min-width: 0;          /* CRITIQUE : évite le débordement flex */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #board-wrap {
      border: 3px solid #00c8ff;
      box-shadow: 0 0 20px #00c8ff55, 0 0 40px #00c8ff22, inset 0 0 8px #00001a;
      line-height: 0;
      flex-shrink: 0;
    }
    #board { display: block; }

    /* ── Panneau droit ── */
    #right-panel {
      flex: 0 0 27%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 6px 4px 18px;
      overflow: hidden;
      min-width: 0;
    }

    /* ══════════════════════════════════════
       TITRE TETRIS (paysage, panneau gauche)
    ══════════════════════════════════════ */
    #title {
      font-size: clamp(1rem, 4vw, 1.8rem);
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: linear-gradient(90deg,
        #ff0000 0%, #ff6600 16%, #ffff00 32%,
        #00ff00 48%, #00aaff 64%, #aa00ff 80%, #ff00aa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ══════════════════════════════════════
       D-PAD
    ══════════════════════════════════════ */
    #dpad {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .drow { display: flex; gap: 4px; align-items: center; }

    .dpad-spacer {
      width: clamp(34px, 8.5vw, 52px);
      height: clamp(34px, 8.5vw, 52px);
    }

    .ctrl-btn {
      width: clamp(34px, 8.5vw, 52px);
      height: clamp(34px, 8.5vw, 52px);
      background: #0e0e38;
      border: 2px solid #00c8ff;
      color: #00c8ff;
      font-size: clamp(0.9rem, 2.6vw, 1.3rem);
      border-radius: 10px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      user-select: none; -webkit-user-select: none;
      box-shadow: 0 0 6px #00c8ff55;
      transition: background 0.08s;
      -webkit-tap-highlight-color: transparent;
    }
    .ctrl-btn:active { background: #00395a; box-shadow: 0 0 12px #00c8ffaa; }

    #chute-label {
      font-size: clamp(0.4rem, 1.3vw, 0.58rem);
      color: #00c8ff;
      letter-spacing: 2px;
      margin-top: 2px;
      text-align: center;
    }

    /* ══════════════════════════════════════
       BARRE DE VITESSE
    ══════════════════════════════════════ */
    #speed-section {
      width: 88%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    #speed-label {
      font-size: clamp(0.4rem, 1.4vw, 0.62rem);
      color: #00c8ff;
      letter-spacing: 3px;
    }
    #speed-track {
      width: 100%; height: 8px;
      background: #0e0e38;
      border: 1px solid #00c8ff;
      border-radius: 4px;
      overflow: hidden;
    }
    #speed-fill {
      height: 100%; width: 5%;
      background: linear-gradient(90deg, #0055ff, #00ffff);
      border-radius: 4px;
      transition: width 0.4s;
    }

    /* ══════════════════════════════════════
       INFO BOXES
    ══════════════════════════════════════ */
    .info-box {
      border: 2px solid #00c8ff;
      padding: 4px 8px;
      width: 88%;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #0a0a28;
      box-shadow: 0 0 8px #00c8ff33;
    }
    .box-label {
      font-size: clamp(0.4rem, 1.4vw, 0.62rem);
      color: #00c8ff;
      letter-spacing: 3px;
      margin-bottom: 2px;
    }
    #score-val {
      font-size: clamp(1rem, 3.2vw, 1.55rem);
      font-weight: 900;
      text-shadow: 0 0 8px #00c8ff88;
    }
    #lines-val {
      font-size: clamp(0.4rem, 1.3vw, 0.58rem);
      color: #8888cc;
      margin-top: 1px;
    }
    #level-val {
      font-size: clamp(0.9rem, 2.6vw, 1.25rem);
      font-weight: 900;
    }
    #next-canvas { display: block; }

    /* ══════════════════════════════════════
       BOUTONS TOUR & PAUSE
    ══════════════════════════════════════ */
    #tour-btn {
      width: clamp(44px, 11vw, 64px);
      height: clamp(44px, 11vw, 64px);
      border-radius: 50%;
      background: #0e0e38;
      border: 3px solid #00c8ff;
      color: #00c8ff;
      font-size: clamp(0.4rem, 1.3vw, 0.58rem);
      font-weight: 900;
      letter-spacing: 1px;
      cursor: pointer;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 2px;
      box-shadow: 0 0 12px #00c8ff55;
      -webkit-tap-highlight-color: transparent;
    }
    #tour-icon { font-size: clamp(1rem, 2.8vw, 1.35rem); line-height: 1; }
    #tour-btn:active { background: #00395a; }

    #pause-btn {
      background: #0e0e38;
      border: 2px solid #00c8ff;
      color: #00c8ff;
      padding: clamp(4px, 1.2vw, 8px) clamp(8px, 2.5vw, 20px);
      font-size: clamp(0.5rem, 1.6vw, 0.75rem);
      letter-spacing: 3px;
      font-weight: 900;
      border-radius: 6px;
      cursor: pointer;
      width: 88%;
      -webkit-tap-highlight-color: transparent;
    }
    #pause-btn:active { background: #003355; }

    /* ══════════════════════════════════════
       OVERLAY (pause / game over)
    ══════════════════════════════════════ */
    #overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,15,0.88);
      display: none;
      flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 200;
      gap: 14px;
    }
    #overlay.show { display: flex; }
    #ov-title {
      font-size: clamp(1.4rem, 5vw, 2.2rem);
      font-weight: 900;
      letter-spacing: 4px;
      color: #ff4444;
      text-shadow: 0 0 20px #ff0000;
    }
    #ov-title.pause-title { color: #00c8ff; text-shadow: 0 0 20px #00c8ff; }
    #ov-score { font-size: clamp(0.8rem, 2.5vw, 1.1rem); color: #ccc; letter-spacing: 2px; }
    #ov-btn {
      background: #0e0e38;
      border: 2px solid #00c8ff;
      color: #00c8ff;
      padding: 10px 30px;
      font-size: clamp(0.7rem, 2.2vw, 0.95rem);
      font-weight: 900;
      letter-spacing: 3px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 12px #00c8ff55;
    }
    #ov-btn:active { background: #003355; }

    /* ══════════════════════════════════════
       SIGNATURE — paysage (fixed, discret)
    ══════════════════════════════════════ */
    #signature {
      position: fixed;
      bottom: 2px; left: 0; right: 0;
      text-align: center;
      font-size: 0.46rem;
      color: rgba(80, 80, 150, 0.55);
      letter-spacing: 2px;
      pointer-events: none;
      z-index: 5;
      font-style: italic;
      font-family: Arial, sans-serif;
    }

    /* ══════════════════════════════════════
       PORTRAIT
       ┌─────────────────┐  ← 57vh  board
       ├────────┬────────┤  ← 43vh-14px  contrôles
       │  left  │ right  │
       ├────────┴────────┤  ← 14px signature
       └─────────────────┘
    ══════════════════════════════════════ */
    @media (orientation: portrait) {

      #app {
        display: grid;
        grid-template-areas:
          "center center"
          "left   right"
          "sig    sig";
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 57vh calc(43vh - 14px) 14px;
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
        align-items: stretch;
      }

      /* Board — pleine largeur, moitié haute */
      #center-panel {
        grid-area: center;
        width: 100%;
        height: 100%;
        padding: 4px 0;
        flex: unset;
        min-width: unset;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      /* Contrôles gauche */
      #left-panel {
        grid-area: left;
        flex: unset;
        min-width: unset;
        width: 100%;
        height: 100%;
        padding: 5px 5px 3px;
        justify-content: space-evenly;
        overflow: hidden;
        border-top: 1px solid #00c8ff44;
        border-right: 1px solid #00c8ff22;
      }

      /* Contrôles droite */
      #right-panel {
        grid-area: right;
        flex: unset;
        min-width: unset;
        width: 100%;
        height: 100%;
        padding: 5px 5px 3px;
        justify-content: space-evenly;
        overflow: hidden;
        border-top: 1px solid #00c8ff44;
      }

      /* Signature dans la 3e ligne de la grille → zéro chevauchement */
      #signature {
        grid-area: sig;
        position: static;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.46rem;
        color: rgba(80, 80, 150, 0.55);
        letter-spacing: 2px;
        font-style: italic;
        font-family: Arial, sans-serif;
        pointer-events: none;
      }

      #title { display: none; }

      /* Boutons D-pad — vw = largeur totale en portrait */
      .ctrl-btn {
        width: clamp(38px, 11vw, 58px);
        height: clamp(38px, 11vw, 58px);
        font-size: clamp(1rem, 3.5vw, 1.4rem);
      }
      .dpad-spacer {
        width: clamp(38px, 11vw, 58px);
        height: clamp(38px, 11vw, 58px);
      }
      #chute-label { font-size: clamp(0.4rem, 2.2vw, 0.58rem); }

      #speed-section { width: 90%; }
      #speed-label   { font-size: clamp(0.4rem, 2.2vw, 0.6rem); }

      .info-box  { width: 90%; padding: 2px 5px; }
      .box-label { font-size: clamp(0.4rem, 2.2vw, 0.6rem); letter-spacing: 2px; margin-bottom: 1px; }

      #score-val { font-size: clamp(1rem, 5.5vw, 1.6rem); }
      #lines-val { font-size: clamp(0.38rem, 2vw, 0.54rem); margin-top: 1px; }
      #level-val { font-size: clamp(0.9rem, 5vw, 1.4rem); }

      #tour-btn   { width: clamp(40px, 12vw, 56px); height: clamp(40px, 12vw, 56px); }
      #tour-icon  { font-size: clamp(0.9rem, 3.8vw, 1.2rem); }

      #pause-btn {
        width: 90%;
        padding: 4px 6px;
        font-size: clamp(0.48rem, 2.8vw, 0.72rem);
      }
    }
  </style>
</head>
<body>

<!-- ══ PAGE D'ACCUEIL ══ -->
<div id="start-screen">
  <h1 id="start-title">TETRIS</h1>
  <div id="start-by">designed by Phil C.</div>
  <button id="start-btn">START</button>
</div>

<!-- ══ JEU ══ -->
<div id="app">

  <div id="left-panel">
    <h1 id="title">TETRIS</h1>
    <div id="dpad">
      <div class="drow">
        <button class="ctrl-btn" id="btn-up"    aria-label="Rotation">&#9650;</button>
      </div>
      <div class="drow">
        <button class="ctrl-btn" id="btn-left"  aria-label="Gauche">&#9664;</button>
        <div class="dpad-spacer"></div>
        <button class="ctrl-btn" id="btn-right" aria-label="Droite">&#9654;</button>
      </div>
      <div class="drow">
        <button class="ctrl-btn" id="btn-down"  aria-label="Chute rapide">&#9660;</button>
      </div>
      <div id="chute-label">CHUTE RAPIDE</div>
    </div>
    <div id="speed-section">
      <div id="speed-label">VITESSE &bull;</div>
      <div id="speed-track"><div id="speed-fill"></div></div>
    </div>
  </div>

  <div id="center-panel">
    <div id="board-wrap">
      <canvas id="board"></canvas>
    </div>
  </div>

  <div id="right-panel">
    <div class="info-box">
      <div class="box-label">SCORE</div>
      <div id="score-val">0</div>
      <div id="lines-val">LIGNES : 0</div>
    </div>
    <div class="info-box">
      <div class="box-label">NEXT</div>
      <canvas id="next-canvas"></canvas>
    </div>
    <button id="tour-btn" aria-label="Rotation">
      <span id="tour-icon">&#8635;</span>
      <span>TOUR</span>
    </button>
    <button id="pause-btn">PAUSE</button>
    <div class="info-box">
      <div class="box-label">NIVEAU</div>
      <div id="level-val">1</div>
    </div>
  </div>

</div>

<!-- signature (portrait = dans la grille CSS, paysage = fixed) -->
<div id="signature">designed by Phil C.</div>

<!-- ══ OVERLAY pause / game over ══ -->
<div id="overlay">
  <div id="ov-title">GAME OVER</div>
  <div id="ov-score">Score : 0</div>
  <button id="ov-btn">REJOUER</button>
</div>

<script>
// ══════════════════════════════════════════════
//  Config
// ══════════════════════════════════════════════
const COLS = 10, ROWS = 20;

const COLORS = {
  I: '#00eeff', O: '#ffee00', T: '#cc00ff',
  S: '#00ee44', Z: '#ff2222', J: '#3344ff', L: '#ff8800'
};

const SHAPES = {
  I: [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  O: [[1,1],[1,1]],
  T: [[0,1,0],[1,1,1],[0,0,0]],
  S: [[0,1,1],[1,1,0],[0,0,0]],
  Z: [[1,1,0],[0,1,1],[0,0,0]],
  J: [[1,0,0],[1,1,1],[0,0,0]],
  L: [[0,0,1],[1,1,1],[0,0,0]]
};

const KICKS = [0, -1, 1, -2, 2];

// ══════════════════════════════════════════════
//  Canvas
// ══════════════════════════════════════════════
const canvas  = document.getElementById('board');
const ctx     = canvas.getContext('2d');
const nextCv  = document.getElementById('next-canvas');
const nextCtx = nextCv.getContext('2d');

let BS = 18;

function isPortrait() { return window.innerHeight > window.innerWidth; }

function calcBS() {
  if (isPortrait()) {
    // Zone board = 57vh - 8px de padding
    const maxH = window.innerHeight * 0.57 - 8;
    // Largeur totale (le board span les 2 colonnes)
    const maxW = window.innerWidth * 0.88;
    return Math.max(10, Math.min(30, Math.floor(maxH / ROWS), Math.floor(maxW / COLS)));
  }
  // Paysage : panneau central = ~46% de la largeur
  const maxH = window.innerHeight * 0.96;
  const maxW  = window.innerWidth  * 0.46;
  return Math.max(10, Math.min(32, Math.floor(maxH / ROWS), Math.floor(maxW / COLS)));
}

function setupCanvas() {
  BS = calcBS();
  canvas.width  = COLS * BS;
  canvas.height = ROWS * BS;
  const NB = isPortrait()
    ? Math.max(10, Math.floor(BS * 0.56))
    : Math.max(14, Math.floor(BS * 0.84));
  nextCv.width  = 4 * NB;
  nextCv.height = 4 * NB;
  nextCv._nb    = NB;
}

// ══════════════════════════════════════════════
//  État du jeu
// ══════════════════════════════════════════════
let board, current, nextPiece;
let score, lines, level;
let paused, over;
let dropSpeed, dropAcc, lastTs, rafId;
let fastDrop = false;
let bag = [];

function fillBag() {
  bag = Object.keys(SHAPES);
  for (let i = bag.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [bag[i], bag[j]] = [bag[j], bag[i]];
  }
}

function drawFromBag() {
  if (!bag.length) fillBag();
  const type = bag.pop();
  return {
    type, color: COLORS[type],
    shape: SHAPES[type].map(r => [...r]),
    x: Math.floor(COLS / 2) - Math.floor(SHAPES[type][0].length / 2),
    y: 0
  };
}

function initGame() {
  board     = Array.from({ length: ROWS }, () => Array(COLS).fill(null));
  score     = 0; lines = 0; level = 1;
  dropSpeed = 850; dropAcc = 0; lastTs = 0;
  paused    = false; over = false; fastDrop = false;
  bag = []; fillBag();
  nextPiece = drawFromBag();
  spawn();
  updateUI();
  hideOverlay();
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}

function spawn() {
  current = nextPiece;
  nextPiece = drawFromBag();
  if (!valid(current, 0, 0)) { over = true; showOverlay(false); }
}

// ══════════════════════════════════════════════
//  Physique
// ══════════════════════════════════════════════
function valid(piece, dx, dy, shape) {
  const s = shape || piece.shape;
  for (let r = 0; r < s.length; r++)
    for (let c = 0; c < s[r].length; c++)
      if (s[r][c]) {
        const nx = piece.x + c + dx, ny = piece.y + r + dy;
        if (nx < 0 || nx >= COLS || ny >= ROWS) return false;
        if (ny >= 0 && board[ny][nx]) return false;
      }
  return true;
}

function rot90(shape) {
  const R = shape.length, C = shape[0].length;
  const out = Array.from({ length: C }, () => Array(R).fill(0));
  for (let r = 0; r < R; r++)
    for (let c = 0; c < C; c++)
      out[c][R - 1 - r] = shape[r][c];
  return out;
}

function rotate() {
  if (!current || paused || over) return;
  const s = rot90(current.shape);
  for (const k of KICKS) {
    if (valid(current, k, 0, s)) { current.shape = s; current.x += k; return; }
  }
}

function ghostDY() {
  let dy = 0;
  while (valid(current, 0, dy + 1)) dy++;
  return dy;
}

function lock() {
  current.shape.forEach((row, r) =>
    row.forEach((cell, c) => {
      if (cell) {
        const ny = current.y + r, nx = current.x + c;
        if (ny >= 0) board[ny][nx] = current.color;
      }
    })
  );
  let cleared = 0;
  for (let r = ROWS - 1; r >= 0; r--) {
    if (board[r].every(v => v !== null)) {
      board.splice(r, 1);
      board.unshift(Array(COLS).fill(null));
      cleared++; r++;
    }
  }
  if (cleared) {
    score += cleared * cleared;
    lines += cleared;
    level = Math.floor(lines / 10) + 1;
    dropSpeed = Math.max(120, 850 - (level - 1) * 50);
    updateUI();
  }
  spawn();
}

function hardDrop() {
  if (!current || paused || over) return;
  current.y += ghostDY();
  lock();
}

// ══════════════════════════════════════════════
//  UI
// ══════════════════════════════════════════════
function updateUI() {
  document.getElementById('score-val').textContent = score;
  document.getElementById('lines-val').textContent = `LIGNES : ${lines}`;
  document.getElementById('level-val').textContent = level;
  document.getElementById('speed-fill').style.width = Math.min(100, (level - 1) * 10) + '%';
}

function showOverlay(isPause) {
  const ov = document.getElementById('overlay');
  const title = document.getElementById('ov-title');
  if (isPause) {
    title.textContent = 'PAUSE'; title.className = 'pause-title';
    document.getElementById('ov-btn').textContent = 'REPRENDRE';
  } else {
    title.textContent = 'GAME OVER'; title.className = '';
    document.getElementById('ov-btn').textContent = 'REJOUER';
  }
  document.getElementById('ov-score').textContent = `Score : ${score}`;
  ov.classList.add('show');
}

function hideOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

// ══════════════════════════════════════════════
//  Dessin
// ══════════════════════════════════════════════
function drawBlock(c2d, x, y, color, bs) {
  c2d.fillStyle = color;
  c2d.fillRect(x * bs + 1, y * bs + 1, bs - 2, bs - 2);
  const hl = Math.max(2, Math.floor(bs * 0.18));
  c2d.fillStyle = 'rgba(255,255,255,0.35)';
  c2d.fillRect(x * bs + 1, y * bs + 1, bs - 2, hl);
  c2d.fillRect(x * bs + 1, y * bs + 1, hl, bs - 2);
  c2d.fillStyle = 'rgba(0,0,0,0.4)';
  c2d.fillRect(x * bs + bs - hl - 1, y * bs + 1, hl, bs - 2);
  c2d.fillRect(x * bs + 1, y * bs + bs - hl - 1, bs - 2, hl);
}

function drawBoard() {
  ctx.fillStyle = '#000014';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#0d0d2e'; ctx.lineWidth = 0.5;
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c < COLS; c++)
      ctx.strokeRect(c * BS, r * BS, BS, BS);

  board.forEach((row, r) =>
    row.forEach((color, c) => { if (color) drawBlock(ctx, c, r, color, BS); })
  );

  if (current && !over) {
    const gd = ghostDY();
    if (gd > 0) {
      ctx.globalAlpha = 0.22;
      current.shape.forEach((row, r) =>
        row.forEach((cell, c) => {
          if (cell) drawBlock(ctx, current.x + c, current.y + r + gd, current.color, BS);
        })
      );
      ctx.globalAlpha = 1;
    }
    current.shape.forEach((row, r) =>
      row.forEach((cell, c) => {
        if (cell) drawBlock(ctx, current.x + c, current.y + r, current.color, BS);
      })
    );
  }

  if (paused && !over) {
    ctx.fillStyle = 'rgba(0,0,15,0.65)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#00c8ff';
    ctx.font = `900 ${BS * 1.8}px Arial Black, Arial`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('PAUSE', canvas.width / 2, canvas.height / 2);
  }
}

function drawNext() {
  const NB = nextCv._nb || 16;
  nextCtx.fillStyle = '#000014';
  nextCtx.fillRect(0, 0, nextCv.width, nextCv.height);
  if (!nextPiece) return;
  const s = nextPiece.shape;
  const ox = Math.floor((4 - s[0].length) / 2);
  const oy = Math.floor((4 - s.length) / 2);
  s.forEach((row, r) =>
    row.forEach((cell, c) => {
      if (cell) {
        nextCtx.fillStyle = nextPiece.color;
        nextCtx.fillRect((c + ox) * NB + 1, (r + oy) * NB + 1, NB - 2, NB - 2);
        nextCtx.fillStyle = 'rgba(255,255,255,0.35)';
        const hl = Math.max(2, Math.floor(NB * 0.18));
        nextCtx.fillRect((c + ox) * NB + 1, (r + oy) * NB + 1, NB - 2, hl);
        nextCtx.fillRect((c + ox) * NB + 1, (r + oy) * NB + 1, hl, NB - 2);
      }
    })
  );
}

// ══════════════════════════════════════════════
//  Boucle de jeu
// ══════════════════════════════════════════════
function loop(ts) {
  if (!over) {
    const dt = lastTs ? ts - lastTs : 0;
    lastTs = ts;
    if (!paused && current) {
      const spd = fastDrop ? Math.min(40, dropSpeed * 0.05) : dropSpeed;
      dropAcc += dt;
      if (dropAcc >= spd) {
        dropAcc = 0;
        if (valid(current, 0, 1)) current.y++;
        else lock();
      }
    }
    drawBoard();
    drawNext();
  }
  rafId = requestAnimationFrame(loop);
}

// ══════════════════════════════════════════════
//  Contrôles — boutons
// ══════════════════════════════════════════════
function btn(id, onPress, onRelease) {
  const el = document.getElementById(id);
  const press = e => { e.preventDefault(); if (onPress) onPress(); };
  const rel   = e => { e.preventDefault(); if (onRelease) onRelease(); };
  el.addEventListener('touchstart', press, { passive: false });
  if (onRelease) el.addEventListener('touchend', rel, { passive: false });
  el.addEventListener('mousedown', press);
  if (onRelease) el.addEventListener('mouseup', rel);
  el.addEventListener('click', press);
}

btn('btn-up',    () => rotate());
btn('btn-left',  () => { if (!paused && !over && current && valid(current, -1, 0)) current.x--; });
btn('btn-right', () => { if (!paused && !over && current && valid(current,  1, 0)) current.x++; });
btn('btn-down',  () => { fastDrop = true; }, () => { fastDrop = false; });
btn('tour-btn',  () => rotate());

document.getElementById('pause-btn').addEventListener('click', togglePause);
document.getElementById('pause-btn').addEventListener('touchstart', e => { e.preventDefault(); togglePause(); }, { passive: false });

function togglePause() {
  if (over) return;
  paused = !paused;
  document.getElementById('pause-btn').textContent = paused ? 'REPRENDRE' : 'PAUSE';
  if (paused) { lastTs = 0; showOverlay(true); }
  else hideOverlay();
}

document.getElementById('ov-btn').addEventListener('click', () => {
  if (over) initGame();
  else { paused = false; document.getElementById('pause-btn').textContent = 'PAUSE'; hideOverlay(); }
});

// ══════════════════════════════════════════════
//  Clavier
// ══════════════════════════════════════════════
const held = {};
document.addEventListener('keydown', e => {
  if (held[e.code]) return;
  held[e.code] = true;
  if (over) { if (e.key === 'Enter') initGame(); return; }
  switch (e.key) {
    case 'ArrowLeft':  if (!paused && current && valid(current, -1, 0)) current.x--; break;
    case 'ArrowRight': if (!paused && current && valid(current,  1, 0)) current.x++; break;
    case 'ArrowDown':  fastDrop = true; break;
    case 'ArrowUp':    rotate(); break;
    case ' ':          e.preventDefault(); if (!paused && current) hardDrop(); break;
    case 'p': case 'P': case 'Escape': togglePause(); break;
  }
});
document.addEventListener('keyup', e => {
  delete held[e.code];
  if (e.key === 'ArrowDown') fastDrop = false;
});

// ══════════════════════════════════════════════
//  Swipe sur le canvas
// ══════════════════════════════════════════════
let tx0, ty0, tTime0;
canvas.addEventListener('touchstart', e => {
  tx0 = e.touches[0].clientX; ty0 = e.touches[0].clientY;
  tTime0 = Date.now();
}, { passive: true });

canvas.addEventListener('touchend', e => {
  if (!e.changedTouches.length || paused || over) return;
  const dx = e.changedTouches[0].clientX - tx0;
  const dy = e.changedTouches[0].clientY - ty0;
  const dt = Date.now() - tTime0;
  const adx = Math.abs(dx), ady = Math.abs(dy);
  if (adx < 12 && ady < 12) { rotate(); return; }
  if (dt < 300) {
    if (adx > ady) {
      if (current && valid(current, dx > 0 ? 1 : -1, 0)) current.x += dx > 0 ? 1 : -1;
    } else if (dy > 30) { hardDrop(); }
  }
}, { passive: true });

// ══════════════════════════════════════════════
//  Resize
// ══════════════════════════════════════════════
window.addEventListener('resize', () => {
  setupCanvas(); drawBoard(); drawNext();
});

// ══════════════════════════════════════════════
//  Start screen
// ══════════════════════════════════════════════
function startGame() {
  document.getElementById('start-screen').classList.add('hidden');
  setupCanvas();
  initGame();
}

const startBtn = document.getElementById('start-btn');
startBtn.addEventListener('click', startGame);
startBtn.addEventListener('touchstart', e => { e.preventDefault(); startGame(); }, { passive: false });

// Init canvas pour le prérendu (pas de boucle de jeu)
setupCanvas();

// ── Service Worker (PWA installable) ──
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
